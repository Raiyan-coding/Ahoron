<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ahoron Web | Company Progress</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
:root{
  --bg-dark: #0f172a;
  --card-dark: rgba(30,41,59,0.9);
  --accent: linear-gradient(90deg,#06b6d4 0%, #60a5fa 100%);
  --accent-solid: #38bdf8;
  --text-gold: #fbbf24;
  --text-main: #eef2ff;
  --text-dim: #94a3b8;
  --border: rgba(51,65,85,0.6);
  --glass: rgba(255,255,255,0.03);
  --radius: 14px;

  /* Score Colors */
  --hex-excellent: #818cf8;
  --hex-good: #34d399;
  --hex-poor: #f87171;

  --space-md: 20px;
  --space-lg: 32px;
}

/* base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg, var(--bg-dark), #071020 80%);
  color: var(--text-main);
  margin:0;
  padding: clamp(16px, 2.5vw, 40px);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

.container{ max-width:1280px; margin:0 auto; width:100% }

/* Header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:var(--space-md);
  padding-bottom:var(--space-md);
  border-bottom: 1px solid var(--border);
  margin-bottom:var(--space-lg);
  flex-wrap:wrap;
}
.brand h1{
  margin:0;
  font-size:clamp(1.05rem,2.6vw,1.3rem);
  font-weight:800;
}
.nav-links{ display:flex; gap:18px; align-items:center; flex-wrap:wrap;}
.nav-links a{
  color:var(--accent-solid);
  text-decoration:none;
  font-weight:700;
  padding:6px 10px;
  border-radius:8px;
}

/* summary/banner */
.summary-banner{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:20px;
  margin-bottom:var(--space-lg);
}
.stat-box{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  padding:22px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  text-align:center;
  backdrop-filter: blur(6px) saturate(120%);
  box-shadow: 0 6px 18px rgba(2,6,23,0.6);
}
.stat-label{ color:var(--text-dim); font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; }
.stat-value{ font-size:clamp(1.6rem,4.6vw,2.5rem); font-weight:900; color:var(--accent-solid); margin-top:6px; display:block; }

/* grid of week cards */
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap:24px;
}

/* week card */
.week-card{
  background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
  border-radius:18px;
  padding:24px;
  border:1px solid var(--border);
  position:relative;
  overflow:hidden;
  transition: transform 250ms ease, box-shadow 250ms ease;
  backdrop-filter: blur(6px);
  min-height:180px;
}
.week-card:hover{ transform: translateY(-6px); box-shadow: 0 20px 40px rgba(2,6,23,0.6); }

.week-card::before{
  content:"";
  position:absolute;
  top:0; left:0; width:100%; height:6px;
  background:var(--border);
}
.lvl-excellent::before{ background: linear-gradient(90deg,var(--hex-excellent), #c7b8ff); box-shadow: 0 0 18px rgba(129,140,248,0.18);}
.lvl-good::before{ background: linear-gradient(90deg,var(--hex-good), #86efac); box-shadow: 0 0 18px rgba(52,211,153,0.12);}
.lvl-poor::before{ background: linear-gradient(90deg,var(--hex-poor), #fca5a5); box-shadow: 0 0 18px rgba(248,113,113,0.12);}

.week-header{ margin-bottom:14px; display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
.week-name{ font-size:clamp(1.05rem,2.8vw,1.45rem); font-weight:800; margin:0; }
.week-range{ color:var(--text-dim); font-size:0.85rem; }

.task-list{ list-style:none; margin:18px 0; padding:0; display:block; max-height:220px; overflow:auto; }
.task-item{
  display:flex; justify-content:space-between; gap:12px;
  padding:10px 0; align-items:center;
  border-bottom:1px solid rgba(51,65,85,0.12);
}
.task-title{ font-weight:700; font-size:0.95rem; color:var(--text-main); white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
.task-meta{ color:var(--text-dim); font-size:0.78rem; }

.task-score{ color:var(--text-gold); font-weight:800; font-size:0.95rem; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.02) }

.percentage-footer{ margin-top:18px; display:flex; align-items:center; gap:14px; justify-content:space-between; flex-wrap:wrap; }
.pct-circle{
  width:64px; height:64px; border-radius:50%; display:flex; align-items:center; justify-content:center;
  font-weight:900; font-size:1.05rem; border:4px solid rgba(255,255,255,0.03);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
  position:relative;
  box-shadow: inset 0 -6px 18px rgba(0,0,0,0.45);
}
/* FIXED: conic-gradient now uses var(--pct) correctly */
.pct-circle::before{
  content:"";
  position:absolute; inset:0; border-radius:50%; padding:4px;
  background:
    conic-gradient(var(--accent-solid) 0% var(--pct, 0%), rgba(255,255,255,0.05) var(--pct, 0%) 100%);
  -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 10px), #000 calc(100% - 9px));
  mask: radial-gradient(farthest-side, transparent calc(100% - 10px), #000 calc(100% - 9px));
  opacity:0.18;
  pointer-events:none;
}
.pct-circle > span{ position:relative; z-index:2; }

.pct-label{ flex:1; min-width:0; }
.pct-label span{ display:block; font-size:0.72rem; color:var(--text-dim); font-weight:700; margin-bottom:6px;}
.pct-bar-bg{ width:100%; height:10px; background: rgba(2,6,23,0.6); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,0.02); }
.pct-bar-fill{ height:100%; border-radius:999px; width: var(--pct, 0%); transition: width 1.2s cubic-bezier(.2,.9,.2,1); background: linear-gradient(90deg, rgba(56,189,248,0.95), rgba(96,165,250,0.95)); }

.card-meta{ display:flex; gap:12px; align-items:center; color:var(--text-dim); font-size:0.82rem; }

.kicker{ color:var(--text-dim); font-size:0.78rem; font-weight:700; }

@media (prefers-reduced-motion: reduce){
  .week-card, .pct-bar-fill{ transition: none !important; transform:none !important; }
}

/* Mobile */
@media (max-width:900px){
  .summary-banner{ grid-template-columns: 1fr; gap:14px; }
  header{ padding-bottom:12px; gap:12px;}
  .stat-value{ font-size:clamp(1.2rem,6vw,1.9rem); }
  .pct-circle{ width:56px; height:56px; font-size:0.95rem; }
  .task-list{ max-height:160px; }
}

.chart-card{
  background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
  border-radius:14px;
  padding:14px;
  border:1px solid var(--border);
  backdrop-filter: blur(4px);
  box-shadow: 0 8px 24px rgba(2,6,23,0.5);
}
@media (max-width:420px){
  #weeklyChart { height: 160px !important; }
}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <h1>Ahoron Web Performance</h1>
      </div>
      <div class="nav-links" aria-hidden="true">
        <!-- future nav -->
      </div>
    </header>

    <!-- NOTE: class name corrected to summary-banner -->
    <div class="summary-banner">
      <div class="stat-box">
        <span class="stat-label">Weeks Active</span>
        <div id="total-weeks" class="stat-value">0</div>
      </div>
      <div class="stat-box">
        <span class="stat-label">Company Avg</span>
        <div id="company-avg" class="stat-value">0.0</div>
      </div>
    </div>

    <!-- Weekly progress chart -->
    <div class="chart-card" aria-hidden="false" style="margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="font-weight:800;font-size:1rem;">Weekly Performance</div>
        <div style="color:var(--text-dim);font-weight:700;font-size:0.9rem;">Avg score per week (0–10)</div>
      </div>
      <canvas id="weeklyChart" height="110"></canvas>
    </div>

    <div class="grid" id="tracker-grid"></div>
  </div>

  <script>
/* ====== CORE FIXES ======
   1) weeklyChartInstance declared BEFORE it's used (avoids TDZ ReferenceError)
   2) conic-gradient in .pct-circle::before fixed (use var(--pct) directly)
   3) HTML class summary-stats -> summary-banner fixed (CSS matches)
   4) Several defensive guards for missing tasks
*/

let weeklyChartInstance = null; // <-- must be defined before drawWeeklyChart or any access

function colorForScore(score){
  const root = getComputedStyle(document.documentElement);
  const excellent = root.getPropertyValue('--hex-excellent')?.trim() || '#818cf8';
  const good = root.getPropertyValue('--hex-good')?.trim() || '#34d399';
  const poor = root.getPropertyValue('--hex-poor')?.trim() || '#f87171';
  if (score >= 9) return excellent;
  if (score >= 7) return good;
  return poor;
}

function drawWeeklyChart(rawData){
  const active = (Array.isArray(rawData) ? rawData : []).filter(w => w && w.active === true);

  const labels = [];
  const values = [];
  const bgColors = [];

  active.forEach(w => {
    const tasks = Array.isArray(w.tasks) ? w.tasks : [];
    const taskCount = tasks.length || 1;
    const weekTotal = tasks.reduce((s,t) => s + (Number(t.rating) || 0), 0);
    const weekAvg = +(weekTotal / taskCount).toFixed(1);
    labels.push(w.week || w.dateRange || 'Week');
    values.push(weekAvg);
    bgColors.push(colorForScore(weekAvg));
  });

  const canvas = document.getElementById('weeklyChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  if (weeklyChartInstance) weeklyChartInstance.destroy();

  weeklyChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Avg score (0–10)',
        data: values,
        backgroundColor: bgColors,
        borderRadius: 8,
        maxBarThickness: 48,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 6, bottom: 6 } },
      scales: {
        x: {
          ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-main') || '#eef2ff' },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          suggestedMax: 10,
          ticks: { stepSize: 1, color: getComputedStyle(document.documentElement).getPropertyValue('--text-dim') || '#94a3b8' },
          grid: { color: 'rgba(255,255,255,0.03)', borderDash: [4,4] }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0b1220',
          titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text-main') || '#eef2ff',
          bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-dim') || '#94a3b8',
          callbacks: {
            label: ctx => ` Avg: ${ctx.formattedValue} / 10`
          }
        }
      },
      animation: { duration: 700, easing: 'easeOutQuart' }
    }
  });
}

async function initDashboard() {
  try {
    const response = await fetch('data.json');
    const rawData = await response.json();

    // draw chart first (safe even if rawData contains inactive weeks)
    drawWeeklyChart(rawData);

    const activeData = (Array.isArray(rawData) ? rawData : []).filter(w => w && w.active === true);
    const grid = document.getElementById('tracker-grid');

    // clear existing
    grid.innerHTML = '';

    let totalGlobalRating = 0;

    activeData.forEach(week => {
      const tasks = Array.isArray(week.tasks) ? week.tasks : [];
      const taskCount = tasks.length;
      const weekTotal = tasks.reduce((sum, t) => sum + (Number(t.rating) || 0), 0);
      const numericWeekAvg = taskCount ? (weekTotal / taskCount) : 0;
      const weekAvgLabel = numericWeekAvg.toFixed(1);

      totalGlobalRating += numericWeekAvg;

      let levelClass = 'lvl-poor';
      if (numericWeekAvg >= 9) levelClass = 'lvl-excellent';
      else if (numericWeekAvg >= 7) levelClass = 'lvl-good';

      const card = document.createElement('div');
      card.className = `week-card ${levelClass}`;
      card.style.setProperty('--pct', `${numericWeekAvg * 10}%`);

      card.innerHTML = `
        <div class="week-header">
          <div>
            <h2 class="week-name">${week.week || 'Week'}</h2>
            <span class="week-range">${week.dateRange || ''}</span>
          </div>
          <div class="avg-badge">
            <span class="task-score">AVG ${weekAvgLabel}</span>
          </div>
        </div>

        <ul class="task-list">
          ${tasks.map(t => `
            <li class="task-item">
              <div style="display:flex;flex-direction:column;">
                <span class="task-title">${t.name || 'Task'}</span>
                <span class="task-meta">${t.meta || ''}</span>
              </div>
              <span class="t-rating">${Number(t.rating)||0}/10</span>
            </li>
          `).join('')}
        </ul>

        <div class="growth-container">
          <div class="growth-bar" style="background:rgba(255,255,255,0.03);height:8px;border-radius:999px;overflow:hidden;">
            <div class="growth-fill" style="width: ${numericWeekAvg * 10}% ; height:100%; background: linear-gradient(90deg, rgba(56,189,248,0.95), rgba(96,165,250,0.95)); border-radius:999px;"></div>
          </div>
        </div>
      `;

      grid.appendChild(card);
    });

    document.getElementById('total-weeks').innerText = activeData.length;
    const globalAvg = activeData.length > 0 ? (totalGlobalRating / activeData.length).toFixed(1) : '0.0';
    document.getElementById('company-avg').innerText = globalAvg;

  } catch (e) {
    console.error("Data could not be loaded. Ensure data.json is in the same folder.", e);
  }
}

initDashboard();
  </script>
</body>
</html>
